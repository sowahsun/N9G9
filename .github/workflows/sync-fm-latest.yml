name: TVAPP - Daily FM Sync (Original Name)
on:
  schedule:
    - cron: '0 */12 * * *' # 每12小时巡检一次
  workflow_dispatch:      # 允许手动触发

jobs:
  incremental_sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync Latest FM
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM: "lystv/fmapp"
          PREFIX: "FM-" # 建议保留前缀以区分 TVAPP 原有版本
        run: |
          # 1. 获取原作者最新 Release 详情
          latest_release=$(gh api repos/$UPSTREAM/releases/latest)
          raw_tag=$(echo "$latest_release" | jq -r '.tag_name')
          my_tag="${PREFIX}${raw_tag}"
          
          # 2. 检查本地是否已存在该版本
          if gh release view "$my_tag" >/dev/null 2>&1; then
            echo "当前已是最新版本 $my_tag，无需更新。"
            exit 0
          fi

          # 3. 提取 Release 信息
          title=$(echo "$latest_release" | jq -r '.name // "No Title"')
          body=$(echo "$latest_release" | jq -r '.body // "No Description"')

          # 4. 创建本地 Release 壳子
          echo "创建 Release: $my_tag"
          gh release create "$my_tag" --title "FM聚合: $title" --notes "$body"

          # 5. 【核心修改点】：按原名搬运所有 APK
          assets=$(echo "$latest_release" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          
          for url in $assets; do
            orig_name=$(basename "$url")
            echo "正在搬运原始文件: $orig_name"
            
            # 下载文件
            curl -L -o "$orig_name" "$url"
            
            # 直接上传原始文件名，不再进行 mv 改名操作
            gh release upload "$my_tag" "$orig_name" --clobber
            
            # 清理临时文件
            rm -f "$orig_name"
          done
