name: TVAPP - Full FM History Sync
on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  clone_all:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone All to TVAPP
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPSTREAM: "lystv/fmapp"
          PREFIX: "FM-" # ğŸ¯ å¢åŠ å‰ç¼€ï¼Œé˜²æ­¢æœªæ¥ä¸å…¶ä»–ä½œè€…å†²çª
        run: |
          # 1. è·å–åŸä½œè€…æ‰€æœ‰ Release æ ‡ç­¾
          tags=$(gh api repos/$UPSTREAM/releases --jq '.[].tag_name')

          for tag in $tags; do
            my_tag="${PREFIX}${tag}"
            echo "-----------------------------------"
            echo "å¤„ç†ç‰ˆæœ¬: $tag -> æ˜ å°„ä¸º: $my_tag"
            
            # æ£€æŸ¥ TVAPP ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥æ ‡ç­¾
            if gh release view "$my_tag" >/dev/null 2>&1; then
              echo "è·³è¿‡ï¼š$my_tag å·²å­˜åœ¨ã€‚"
              continue
            fi

            # 2. è·å–è¯¦æƒ…
            release_info=$(gh api repos/$UPSTREAM/releases/tags/$tag)
            title=$(echo "$release_info" | jq -r '.name // "No Title"')
            body=$(echo "$release_info" | jq -r '.body // "No Description"')

            # 3. åˆ›å»º Release å£³å­
            gh release create "$my_tag" --title "FMèšåˆ: $title" --notes "$body"

            # 4. ä¸‹è½½ã€é‡å‘½åå¹¶ä¸Šä¼ 
            assets=$(echo "$release_info" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
            
            for url in $assets; do
              orig_name=$(basename "$url")
              curl -L -o "$orig_name" "$url"
              
              # ç»Ÿä¸€é‡å‘½åé€»è¾‘
              if [[ "$orig_name" == *"mobile"* ]]; then
                target_name="fmapp_mobile.apk"
              else
                target_name="fmapp_tv.apk"
              fi
              
              # åŒæ—¶ä¿ç•™åŸåå¤‡ä»½ï¼ˆå¯é€‰ï¼‰å’Œä¸Šä¼ æ´—ç™½å
              gh release upload "$my_tag" "$orig_name" --clobber
              mv "$orig_name" "$target_name"
              gh release upload "$my_tag" "$target_name" --clobber
              
              rm -f "$target_name"
            done
          done
