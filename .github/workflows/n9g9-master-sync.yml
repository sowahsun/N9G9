name: N9G9 - Protected Master Sync (Daily)
on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©å‡Œæ™¨ 00:00 å·¡æ£€
  workflow_dispatch:      # å…è®¸éšæ—¶æ‰‹åŠ¨æ•‘æ€¥

jobs:
  # -------------------------------------------------------------------
  # 1ï¸âƒ£ ä¿æŠ¤æ¨¡å¼åŒæ­¥ï¼šé˜²æ­¢ reset --hard æŠ¹é™¤æœ¬è„šæœ¬
  # -------------------------------------------------------------------
  code_absolute_sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Forced Mirror with Protection
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          echo "ğŸŸ¢ [æ‰‹æœ¯åŒºï¼šå¤‡ä»½] æ­£åœ¨å°†å·¥ä½œæµè„šæœ¬ç§»å…¥ä¸´æ—¶éš”ç¦»åŒº..."
          mkdir -p ../wf_backup
          cp .github/workflows/*.yml ../wf_backup/
          
          echo "ğŸŸ¡ [æ¸…åœºåŒºï¼šåŒæ­¥] æ‰§è¡Œä¸Šæ¸¸å¼ºåŠ›å¯¹é½..."
          git remote add upstream https://github.com/youhunwl/TVAPP.git
          git fetch upstream main --depth=1
          git checkout main
          git reset --hard upstream/main
          
          echo "ğŸŸ¢ [æ‰‹æœ¯åŒºï¼šæ¤å›] æ­£åœ¨ä»éš”ç¦»åŒºæ¢å¤å·¥ä½œæµè„šæœ¬..."
          mkdir -p .github/workflows
          cp ../wf_backup/*.yml .github/workflows/
          
          echo "ğŸ”µ [æäº¤åŒºï¼šå…¥åº“] ç¡®ä¿æŒä¹…åŒ–å­˜å‚¨..."
          git add .github/workflows/
          git commit -m "System: Auto-protect workflows after absolute sync" || echo "No change"
          git push origin main --force

  # -------------------------------------------------------------------
  # 2ï¸âƒ£ FMApp å¢é‡åŒæ­¥ï¼šAPI æ¨¡å¼ï¼Œç§’çº§æ¬è¿
  # -------------------------------------------------------------------
  fmapp_release_sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Instant Sync FMApp
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ github.repository }}
          SOURCE_REPO: "lystv/fmapp"
          PREFIX: "FM-"
        run: |
          latest_rel=$(gh api repos/$SOURCE_REPO/releases/latest)
          raw_tag=$(echo "$latest_rel" | jq -r '.tag_name')
          my_tag="${PREFIX}${raw_tag}"
          
          if gh release view "$my_tag" -R "$TARGET_REPO" >/dev/null 2>&1; then
            echo "âœ… FMApp ç‰ˆæœ¬ $my_tag å·²å­˜åœ¨ï¼Œè·³è¿‡ã€‚"
            exit 0
          fi

          echo "ğŸš€ å‘ç° FMApp æ–°ç‰ˆæœ¬: $raw_tag"
          title=$(echo "$latest_rel" | jq -r '.name // "New FM Release"')
          body=$(echo "$latest_rel" | jq -r '.body // "Incremental Update"')

          gh release create "$my_tag" -R "$TARGET_REPO" --title "FMApp: $title" --notes "$body"

          assets=$(echo "$latest_rel" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
          for url in $assets; do
            orig_name=$(basename "$url")
            curl -L -o "$orig_name" "$url"
            gh release upload "$my_tag" "$orig_name" --clobber -R "$TARGET_REPO"
            rm -f "$orig_name"
          done
