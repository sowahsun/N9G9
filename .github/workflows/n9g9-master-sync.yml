name: N9G9 - Precision Sync & Timestamp Index
on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©å‡Œæ™¨å·¡æ£€
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨æ‰§è¡Œ

jobs:
  code_absolute_sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ‹‰å–å®Œæ•´ Git å†å²

      - name: æ‰§è¡Œå¯¹é½ã€æ¢å¤ä¸ Git æ·±åº¦ç´¢å¼•ç”Ÿæˆ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. åˆå§‹åŒ– Git
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # 2. éš”ç¦»ä¿æŠ¤ï¼šå¤‡ä»½å½“å‰å·¥ä½œæµ
          mkdir -p ../wf_backup && cp .github/workflows/*.yml ../wf_backup/
          
          # 3. å¼ºåŠ›å¯¹é½ï¼šæ‹‰å–ä¸Šæ¸¸å®Œæ•´å†å²
          git remote add upstream https://github.com/youhunwl/TVAPP.git
          git fetch upstream main 
          git checkout main && git reset --hard upstream/main
          
          # 4. æ¢å¤ä¿æŠ¤ï¼šè¿˜åŸå·¥ä½œæµ
          mkdir -p .github/workflows && cp ../wf_backup/*.yml .github/workflows/

          echo "ğŸŸ  [ç´¢å¼•] æ­£åœ¨æ‰«æ 223+ APK æ–‡ä»¶çš„çœŸå®å†å²..."
          rm -f repo_files_raw.txt

          # A. å…¨ç›˜æ‰«æ (åšå¦‚ç£çŸ³çš„ while å¾ªç¯ç‰ˆï¼Œå½»åº•å‘Šåˆ«å•å¼•å·åœ°ç‹±)
          while IFS= read -r -d '' filepath; do
            if [[ "$filepath" == *.apk ]] && [[ ! "$filepath" =~ ^\.github/ ]] && [[ ! "$filepath" =~ ^wiki/ ]]; then
              committime=$(git log -1 --format=%ai -- "$filepath")
              echo "$filepath|$committime" >> repo_files_raw.txt
            fi
          done < <(git ls-files -z)

          # è½¬ä¸º JSON (åˆ©ç”¨ jq å®‰å…¨æ³¨å…¥ GitHub ä»“åº“å)
          if [ -f repo_files_raw.txt ]; then
            cat repo_files_raw.txt | jq -R -s -c --arg repo "${{ github.repository }}" '
              split("\n") | map(select(length > 0)) | map(split("|") | {
                name: (.[0] | split("/") | last),
                type: "repo_file",
                path: .[0],
                time: .[1],
                url: ("https://raw.githubusercontent.com/" + $repo + "/main/" + (.[0] | split("/") | map(gsub(" "; "%20")) | join("/")))
              })
            ' > repo_files.json
          else
            echo "[]" > repo_files.json
          fi

          # B. æ‰«æ Release
          gh api repos/${{ github.repository }}/releases --jq '
            [.[] | {tag: .tag_name, assets: .assets}] | map(select(.assets | length > 0)) 
            | [.[] | .tag as $tag | .assets[] | select(.name | endswith(".apk")) | {
                name: ("[" + $tag + "] " + .name), 
                type: "release_asset", 
                path: ("Releases/" + $tag + "/" + .name), 
                time: .updated_at,
                url: .browser_download_url
              }]
          ' > release_assets.json

          # C. åˆå¹¶å¹¶æäº¤
          jq -s 'add' repo_files.json release_assets.json > list.json
          rm -f repo_files_raw.txt
          
          # D. æå–åº”ç”¨æè¿° (ç»ˆææ€æ‰‹é”ï¼šåˆ©ç”¨ Heredoc å†™å…¥ç‹¬ç«‹ Python è„šæœ¬ï¼Œå½»åº•è§£å†³ç¼–ç ä¸ç¼©è¿›é—®é¢˜)
          echo "ğŸŸ  [æè¿°] æ­£åœ¨ä» README.md æå–åº”ç”¨ä»‹ç»..."
          cat << 'EOF' > parse_desc.py
          import json, re, os

          desc = {}
          if os.path.exists('README.md'):
              with open('README.md', 'r', encoding='utf-8') as f:
                  for line in f:
                      # åªæŠ“å–è¡¨æ ¼è¡Œï¼Œæ’é™¤è¡¨å¤´å’Œåˆ†å‰²çº¿
                      if line.startswith('|') and 'APPåç§°' not in line and '---' not in line:
                          parts = [p.strip() for p in line.split('|')]
                          # ç¡®ä¿è¡¨æ ¼åˆ—æ•°å¤Ÿé•¿
                          if len(parts) >= 6:
                              name = parts[1]
                              remark = parts[5]
                              # æ­£åˆ™æ´—æ‰ Markdown é“¾æ¥å’ŒåŠ ç²—ç¬¦å·
                              name = re.sub(r'\[(.*?)\]\(.*?\)', r'\1', name)
                              name = name.replace('**', '').strip()
                              
                              if name and remark:
                                  desc[name] = remark

          # æ— è®ºå‘ç”Ÿä»€ä¹ˆï¼Œéƒ½å¼ºåˆ¶å†™å…¥ä¸€ä¸ªæ ‡å‡† JSON å¯¹è±¡ï¼ˆå“ªæ€•æ˜¯ç©ºçš„ {}ï¼‰ï¼Œç»ä¸ä¼šäº§ç”Ÿ null
          with open('desc.json', 'w', encoding='utf-8') as f:
              json.dump(desc, f, ensure_ascii=False)
          EOF
          
          python3 parse_desc.py
          rm -f parse_desc.py

          # E. å…¨è‡ªåŠ¨ç”Ÿæˆä¸ªæ€§åŒ– README (ä¿ç•™æ¥å£æºã€ç›´æ’­æºä¸è‡´è°¢ï¼Œæè‡´æ’ç‰ˆ)
          echo "ğŸŸ  [æ’ç‰ˆ] æ­£åœ¨æ ¹æ®æœ€æ–°æ•°æ®é‡å†™ README.md..."
          cat << 'EOF' > build_readme.py
          import json
          import os

          # 1. è¯»å–åº”ç”¨æ•°æ®
          try:
              with open('list.json', 'r', encoding='utf-8') as f:
                  apps = json.load(f)
              with open('desc.json', 'r', encoding='utf-8') as f:
                  desc_map = json.load(f)
          except Exception as e:
              print("è¯»å– JSON å¤±è´¥:", e)
              apps, desc_map = [], {}

          # 2. æ ¸å¿ƒæ–°å¢ï¼šæå–ä¸Šæ¸¸åŸç‰ˆçš„â€œæ¥å£æºâ€å’Œâ€œç›´æ’­æºâ€å†…å®¹ï¼ŒåŸå°ä¸åŠ¨ä¿ç•™
          sources_content = ""
          capture = False
          if os.path.exists('README.md'):
              with open('README.md', 'r', encoding='utf-8') as f:
                  for line in f:
                      # é‡åˆ°â€œæ¥å£æºâ€æ ‡é¢˜å¼€å§‹æŠ“å–
                      if line.startswith('## æ¥å£æº'):
                          capture = True
                      # é‡åˆ°â€œå…è´£å£°æ˜â€æ ‡é¢˜åœæ­¢æŠ“å–
                      if line.startswith('## å…è´£å£°æ˜'):
                          capture = False
                      
                      if capture:
                          sources_content += line

          if apps:
              # 3. æŒ‰æ›´æ–°æ—¶é—´é™åºæ’åˆ—
              apps.sort(key=lambda x: x.get('time', ''), reverse=True)

              # 4. æ‹¼æ¥æˆ‘ä»¬ä¸“å±çš„ Markdown å¤´éƒ¨å’Œåº”ç”¨è¡¨æ ¼
              md = "# ğŸš€ N9G9 æé€Ÿåº”ç”¨å•†åº—\n\n"
              md += "> âš¡ï¸ **å…¨è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ›´æ–°**ï¼Œä¸ºæ‚¨æä¾›æœ€æ–°ã€æœ€å…¨çš„ TVBox å£³å­ä¸å½±è§†èšåˆåº”ç”¨ã€‚\n\n"
              
              md += "## ğŸ“¦ æœ€æ–°åº”ç”¨ä¸€è§ˆè¡¨ (è‡ªåŠ¨æ’ç‰ˆä¸æ›´æ–°)\n\n"
              md += "| APPåç§° | æ›´æ–°æ—¥æœŸ | æè¿° | ä¸‹è½½ç›´é“¾ |\n"
              md += "| :--- | :--- | :--- | :--- |\n"

              desc_keys = sorted(desc_map.keys(), key=len, reverse=True)

              for app in apps:
                  name = app.get('name', 'Unknown')
                  time_str = app.get('time', '')[:10]  # åªæˆªå– YYYY-MM-DD
                  url = app.get('url', '#')
                  
                  app_desc = "æš‚æ— è¯¦ç»†æè¿°"
                  for key in desc_keys:
                      if key in name:
                          app_desc = desc_map[key]
                          break
                  
                  app_desc = app_desc.replace('\n', '').replace('\r', '').replace('|', '&#124;')
                  md += f"| **{name}** | `{time_str}` | {app_desc} | [ğŸ“¥ ä¸‹è½½]({url}) |\n"

              # 5. æ— ç¼æ’å…¥ä¸Šæ¸¸åŸæ±åŸå‘³çš„æ¥å£æºå’Œç›´æ’­æº
              md += "\n---\n\n"
              if sources_content:
                  md += sources_content
              else:
                  md += "## æ¥å£æºä¸ç›´æ’­æº\n\n> æš‚æœªæŠ“å–åˆ°ä¸Šæ¸¸æ¥å£æ•°æ®ã€‚\n\n"

              # 6. å®Œç¾èåˆä¸Šæ¸¸çš„è‡´è°¢ä¸æ‰“èµç 
              md += "\n---\n\n"
              md += "## ğŸ™ å£°æ˜ä¸è‡´è°¢\n\n"
              md += "- ğŸš« **å…è´£å£°æ˜**ï¼šæœ¬é¡¹ç›®ä»…ä½œæŠ€æœ¯åˆ†äº«ä¸è‡ªåŠ¨åŒ–æ„å»ºæ¼”ç¤ºï¼Œæ‰€æœ‰èµ„æºç‰ˆæƒå½’åŸä½œè€…ï¼Œä¸¥ç¦å•†ä¸šç”¨é€”ï¼\n"
              md += "- ğŸ”— **æ•°æ®æ¥æº**ï¼šæ ¸å¿ƒæ•°æ®ä¸æ–‡ä»¶å®æ—¶åŒæ­¥è‡ªå¤§ç¥ä»“åº“ [youhunwl/TVAPP](https://github.com/youhunwl/TVAPP)ã€‚\n"
              md += "- â˜• **èµåŠ©åŸä½œè€…**ï¼šç»´æŠ¤ä¸æ˜“ï¼Œå¦‚æœè¿™äº›åº”ç”¨å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œ**è¯·åŠ¡å¿…æ‰«æä¸‹æ–¹äºŒç»´ç æ”¯æŒåŸä½œè€…**ï¼Œè¿™å°†è®©å¼€æºç”Ÿæ€ç»§ç»­èµ°ä¸‹å»ï¼\n\n"
              md += '<img src="https://github.com/user-attachments/assets/d3ab1e47-9409-4636-bb7a-25803dcd2cbd" width="50%">\n'

              # 7. è¦†ç›–å†™å…¥
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(md)
          EOF

          python3 build_readme.py
          rm -f build_readme.py
          
          # åŒæ­¥æäº¤ list.json, desc.json å’Œé‡æ–°ç”Ÿæˆçš„ README.md
          git add .github/workflows/ list.json desc.json README.md
          git commit -m "System: Auto-build beautiful README & Extract Desc" || exit 0
          git push origin main --force

  fmapp_release_sync:
    needs: code_absolute_sync
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Sync FMApp PRO
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_REPO: ${{ github.repository }}
        run: |
          latest_rel=$(gh api repos/lystv/fmapp/releases | jq -c '[.[] | select(.tag_name | ascii_downcase | contains("pro"))][0]')
          if [ "$latest_rel" != "null" ]; then
            raw_tag=$(echo "$latest_rel" | jq -r '.tag_name')
            my_tag="FM-${raw_tag}"
            if ! gh release view "$my_tag" -R "$TARGET_REPO" >/dev/null 2>&1; then
              gh release create "$my_tag" -R "$TARGET_REPO" --title "FMApp: $raw_tag" --notes "Auto-synced"
              assets=$(echo "$latest_rel" | jq -r '.assets[] | select(.name | endswith(".apk")) | .browser_download_url')
              for url in $assets; do
                curl -L -o "temp.apk" "$url"
                gh release upload "$my_tag" "temp.apk" --clobber -R "$TARGET_REPO" --name "$(basename $url)"
              done
            fi
          fi
